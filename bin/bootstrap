#!/bin/bash 

# pull down spack-infrastructure and use it to install spack

usage() {
  cat <<EOF
usage: bootstrap [--with_padding] [--help] [dest_dir] [spack_infrastructure_version] [spack_version]
EOF
}
default_spack_infrastructure_version=v2.19.01
default_spack_version=v0.19.fermi

parse_args() {
    with_padding=""
    eval set : $(getopt --longoptions with_padding,help -- x "$@")
    shift
    while [ "${1:0:2}" = "--" ]
    do
        case "x$1" in
        x--with_padding) with_padding="--with_padding"; shift; continue;;
        x--help) usage; exit;;
        x--) shift; break;;
        esac
    done
    echo "after while: args $*"
    dest=${1:-$PWD}
    ver=${2:-$default_spack_infrastructure_version}
    spackver=${3:-$default_spack_version}
}

detail_log() {
    logfile=/tmp/bootstrap$$.log 
    exec 3>&1 > $logfile 2>&1
    echo "Putting detail log in /tmp/bootstrap$$.log" >&3 
}

monitor() {
   f=$1
   sd=$2
   box="[                                                  ]"
   lin="[==================================================]"

   printf "$box\r" >&3
   while :
   do
       duf=$(du -b $f)
       ds="${duf%$f}"
       dpp1=$(expr $ds / $sd + 1)
       printf "${lin:0:$dpp1}\r" >&3
       sleep 2
   done
}
start_monitor() {
  monitor $* &
  monitor_pid=$!
}
stop_monitor() {
 [ -n "$monitor_pid" ] && kill $monitor_pid 
 clr="                                                    "
 printf "\r$clr\r" >&3
}
message() {
    stop_monitor
    echo $* >&3
    start_monitor $logfile 458
}

main() {
    parse_args "$@"

    detail_log

    mkdir -p $dest/spack-infrastructure/$ver
    cd $dest

    message "Cloning FNALssi spack-infrastructure repository"
    git clone -b $ver https://github.com/FNALssi/spack-infrastructure.git spack-infrastructure/$ver/NULL/

    PATH=$dest/spack-infrastructure/$ver/NULL/bin:$PATH

    message "Setting up spack"
    make_spack --spack_release $spackver $with_padding --minimal -u $dest

    source $dest/setup-env.sh

    message "Adding local compilers"
    spack compiler find --scope=site

    message "Declaring our spack-infrastructure copy to spack"
    cd $dest/spack-infrastructure/$ver/NULL && bin/declare_simple spack-infrastructure $ver
}

main "$@"

